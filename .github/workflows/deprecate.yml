name: Deprecate Legacy Packages

on:
  workflow_dispatch:
    inputs:
      scope:
        description: 'npm scope of the legacy packages (without @), e.g. ccbd-seo'
        required: true
        default: 'ccbd-seo'

jobs:
  deprecate:
    name: Deprecate legacy packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org

      - name: Authenticate with npm
        run: npm config set "//registry.npmjs.org/:_authToken" "$NPM_TOKEN"
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN_90_DAYS }}

      - name: Deprecate packages
        run: |
          SCOPE="${{ github.event.inputs.scope }}"
          for pkg in readability sitemap tracking; do
            FULL="@${SCOPE}/${pkg}"
            if npm view "$FULL" version &>/dev/null; then
              echo "Deprecating $FULL..."
              npm deprecate "$FULL" "⚠️ This package has moved. Use @power-seo/${pkg} instead: npm install @power-seo/${pkg}"
              echo "✓ Deprecated $FULL"
            else
              echo "⚠️ $FULL not found on npm — skipping"
            fi
          done
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN_90_DAYS }}

      - name: Summary
        run: |
          SCOPE="${{ github.event.inputs.scope }}"
          echo "## Deprecation Complete" >> $GITHUB_STEP_SUMMARY
          echo "Processed packages under \`@${SCOPE}/\` scope." >> $GITHUB_STEP_SUMMARY
